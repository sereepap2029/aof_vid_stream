{% extends "base.html" %}

{% block title %}AOF Video Stream - Camera{% endblock %}

{% block content %}
<div class="camera-section">
    <div class="camera-header">
        <h2 class="camera-title">Camera Stream</h2>
        <div class="camera-controls">
            <select id="camera-select" class="control-select">
                <option value="">Select Camera...</option>
            </select>
            <select id="stream-mode-select" class="control-select">
                <option value="websocket" selected>WebSocket (Standard)</option>
                <option value="webrtc">WebRTC (High Performance)</option>
                <option value="polling">HTTP Polling (Compatible)</option>
            </select>
            <button id="start-btn" class="btn btn-success">Start Stream</button>
            <button id="stop-btn" class="btn btn-danger" disabled>Stop Stream</button>
        </div>
    </div>

    <div class="video-container">
        <div class="video-wrapper">
            <canvas id="video-canvas" class="video-display">
                Your browser does not support the HTML5 canvas element.
            </canvas>
            <div id="video-placeholder" class="video-placeholder">
                <div class="placeholder-content">
                    <div class="placeholder-icon">üì∑</div>
                    <h3>No Video Stream</h3>
                    <p>Select a camera and click "Start Stream" to begin</p>
                </div>
            </div>
        </div>
        
        <div class="video-info">
            <div class="info-item">
                <span class="info-label">Status:</span>
                <span id="stream-status" class="info-value">Stopped</span>
            </div>
            <div class="info-item">
                <span class="info-label">Resolution:</span>
                <span id="stream-resolution" class="info-value">N/A</span>
            </div>
            <div class="info-item">
                <span class="info-label">FPS:</span>
                <span id="stream-fps" class="info-value">N/A</span>
            </div>
            <div class="info-item">
                <span class="info-label">Device:</span>
                <span id="stream-device" class="info-value">None</span>
            </div>
            <div class="info-item">
                <span class="info-label">Bitrate:</span>
                <span id="stream-bitrate" class="info-value">0 Mbps</span>
            </div>
            <div class="info-item">
                <span class="info-label">Quality:</span>
                <span id="stream-quality" class="info-value">100%</span>
            </div>
            <div id="performance-stats" class="performance-stats" style="display: none;">
                <div class="info-item">
                    <span class="info-label">Chunk Rate:</span>
                    <span id="chunk-rate" class="info-value">0 chunks/s</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Buffer Size:</span>
                    <span id="buffer-size" class="info-value">0 KB</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lost Chunks:</span>
                    <span id="lost-chunks" class="info-value">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Reassembly:</span>
                    <span id="reassembly-time" class="info-value">0 ms</span>
                </div>
            </div>
        </div>
    </div>

    <div class="camera-settings">
        <h3 class="settings-title">Stream Settings</h3>
        <div class="settings-grid">
            <div class="setting-group">
                <label for="resolution-select" class="setting-label">Resolution:</label>
                <select id="resolution-select" class="setting-select">
                    <option value="640x480">640 x 480</option>
                    <option value="800x600">800 x 600</option>
                    <option value="1024x768">1024 x 768</option>
                    <option value="1280x720">1280 x 720 (HD)</option>
                    <option value="1920x1080" selected>1920 x 1080 (Full HD)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="fps-select" class="setting-label">Frame Rate:</label>
                <select id="fps-select" class="setting-select">
                    <option value="15">15 FPS</option>
                    <option value="24">24 FPS</option>
                    <option value="30">30 FPS</option>
                    <option value="60" selected>60 FPS (WebRTC)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="quality-select" class="setting-label">Quality:</label>
                <select id="quality-select" class="setting-select">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="ultra">Ultra</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="encoding-select" class="setting-label">Encoding:</label>
                <select id="encoding-select" class="setting-select">
                    <option value="binary" selected>Binary (Fastest)</option>
                    <option value="base64">Base64 (Compatible)</option>
                    <option value="compressed">Compressed (Experimental)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="codec-select" class="setting-label">Video Codec:</label>
                <select id="codec-select" class="setting-select">
                    <option value="auto" selected>Auto (Best Available)</option>
                    <option value="H264">H.264 (Most Compatible)</option>
                    <option value="H265">H.265 (Best Quality)</option>
                    <option value="VP8">VP8 (WebM)</option>
                    <option value="VP9">VP9 (WebM)</option>
                    <option value="MJPG">Motion JPEG</option>
                    <option value="JPEG">JPEG (Fallback)</option>
                </select>
                <small class="setting-help">Choose codec for hardware encoding</small>
            </div>
            
            <div class="setting-group">
                <label for="max-bitrate-input" class="setting-label">Max Bitrate (kbps):</label>
                <input type="number" id="max-bitrate-input" class="setting-input" 
                       placeholder="0 = unlimited" min="0" max="50000" step="100" value="0">
                <small class="setting-help">Set maximum bitrate limit (0 for unlimited)</small>
            </div>
            
            <div class="setting-group">
                <label for="hardware-encoding-toggle" class="setting-label">Hardware Encoding:</label>
                <div class="toggle-container">
                    <input type="checkbox" id="hardware-encoding-toggle" class="toggle-checkbox" checked>
                    <label for="hardware-encoding-toggle" class="toggle-label">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">Enable NVIDIA NVENC</span>
                    </label>
                </div>
                <small class="setting-help">Use GPU acceleration for better performance</small>
            </div>
            
            <div class="setting-group">
                <button id="apply-settings-btn" class="btn btn-secondary">Apply Settings</button>
            </div>
        </div>
        
        <!-- Hardware Encoding Status -->
        <div class="encoding-status">
            <h4 class="status-title">Encoding Status</h4>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Method:</span>
                    <span id="encoding-method" class="status-value">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Codec:</span>
                    <span id="current-codec" class="status-value">Auto</span>
                </div>
                <div class="status-item">
                    <span class="status-label">FourCC:</span>
                    <span id="current-fourcc" class="status-value">N/A</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Frames Encoded:</span>
                    <span id="frames-encoded" class="status-value">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Avg Encode Time:</span>
                    <span id="avg-encode-time" class="status-value">0 ms</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Capability:</span>
                    <span id="encoding-fps-capability" class="status-value">0 FPS</span>
                </div>
            </div>
        </div>
    </div>

    <div class="camera-actions">
        <h3 class="actions-title">Actions</h3>
        <div class="actions-grid">
            <button id="snapshot-btn" class="btn btn-info" disabled>
                üì∏ Take Snapshot
            </button>
            <button id="fullscreen-btn" class="btn btn-secondary" disabled>
                üîç Fullscreen
            </button>
            <button id="refresh-devices-btn" class="btn btn-warning">
                üîÑ Refresh Devices
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Socket.IO for WebSocket video streaming -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<!-- WebSocket video streaming client -->
<script src="{{ url_for('static', filename='js/websocket-video.js') }}"></script>
<!-- WebRTC video streaming client -->
<script src="{{ url_for('static', filename='js/webrtc-video.js') }}"></script>
<!-- Enhanced camera controls with WebSocket support -->
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
{% endblock %}
